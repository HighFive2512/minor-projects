{% extends 'layout.html' %}

{% block title %}View Shifts{% endblock %}

{% block content %}
    <h2>View Shifts</h2>

    <!-- Role Filter Dropdown -->
    <label for="role">Filter by Role:</label>
    <select name="role" id="role">
        <option value="">All Roles</option> <!-- Option to view all roles -->
        {% for role in roles %}
            <option value="{{ role[0] }}">{{ role[0] }}</option>
        {% endfor %}
    </select>

    <div id="calendar"></div>

    <!-- Modal for Shift Removal Confirmation -->
    <div id="removeModal" style="display:none;">
        <div>
            <h3>Confirm Removal</h3>
            <p>Are you sure you want to remove this shift?</p>
            <button id="confirmRemove">Yes, Remove</button>
            <button id="cancelRemove">Cancel</button>
        </div>
    </div>

    <script>
        let shiftToRemove = null; // Variable to store the shift being removed

        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');

            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridWeek',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridWeek,dayGridMonth'
                },
                events: [
                    {% for shift in shifts %}
                        {
                            id: '{{ shift[0] }}',
                            title: '{{ shift[1] }} - {{ shift[3] }}', // Add shift type to title for clarity
                            start: '{{ shift[2] }}',
                            extendedProps: {
                                shiftType: '{{ shift[3] }}',
                                role: '{{ shift[4] }}'
                            }
                        }{% if not loop.last %},{% endif %}
                    {% endfor %}
                ],
                eventDidMount: function(info) {
                    let shiftType = info.event.extendedProps.shiftType;
                    info.el.classList.add('shift-default'); // Default class
                    // Customize event appearance based on shift type
                    if (shiftType === "Morning") {
                        info.el.classList.add('shift-morning');
                    } else if (shiftType === "Late") {
                        info.el.classList.add('shift-late');
                    }
                },
                eventClick: function(info) {
                    // Show confirmation modal when an event is clicked
                    shiftToRemove = info.event.id; // Store the ID of the event to remove
                    document.getElementById('removeModal').style.display = 'block';
                }
            });

            calendar.render(); // Render the calendar

            // Handle role filtering
            document.getElementById('role').addEventListener('change', function() {
                var selectedRole = this.value;

                // Clear all events from the calendar
                calendar.removeAllEvents();

                // Re-add events based on selected role
                {% for shift in shifts %}
                    if (selectedRole === "" || "{{ shift[4] }}" === selectedRole) {
                        calendar.addEvent({
                            id: '{{ shift[0] }}',
                            title: '{{ shift[1] }} - {{ shift[3] }}', // Add shift type to title for clarity
                            start: '{{ shift[2] }}',
                            extendedProps: {
                                shiftType: '{{ shift[3] }}',
                                role: '{{ shift[4] }}'
                            }
                        });
                    }
                {% endfor %}
            });

            // Confirm removal of shift
            document.getElementById('confirmRemove').addEventListener('click', function() {
                if (shiftToRemove) {
                    fetch(`/delete_shift/${shiftToRemove}`, {
                        method: 'DELETE',
                    })
                    .then(response => {
                        if (response.ok) {
                            calendar.getEventById(shiftToRemove).remove(); // Remove the event from the calendar
                            alert('Shift removed successfully.');
                        } else {
                            alert('Error removing shift.');
                        }
                        document.getElementById('removeModal').style.display = 'none'; // Close modal
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error removing shift.');
                        document.getElementById('removeModal').style.display = 'none'; // Close modal
                    });
                }
            });

            // Cancel removal
            document.getElementById('cancelRemove').addEventListener('click', function() {
                document.getElementById('removeModal').style.display = 'none'; // Close modal
            });
        });
    </script>
{% endblock %}
